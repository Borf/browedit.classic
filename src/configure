#!/usr/bin/php
<?
chdir("src");
$files = array(	
"RSMModel.cpp",
"common.cpp",
"filesystem.cpp",
"font.cpp",
"frustum.cpp",
"graphics.cpp",
"grflib/zlib/deflate.c",
"grflib/zlib/zutil.c",
"grflib/zlib/crc32.c",
"grflib/zlib/inftrees.c",
"grflib/zlib/inflate.c",
"grflib/zlib/trees.c",
"grflib/zlib/inffast.c",
"grflib/zlib/compress.c",
"grflib/zlib/adler32.c",
"grflib/grfcrypt.c",
"grflib/grf.c",
"grflib/rgz.c",
"grflib/grfsupport.c",
"main.cpp",
"md5.c",
"texture.cpp",
"texturecache.cpp",
"texturemodel.cpp",
"wm/windowinputbox.cpp",
"wm/windowobject.cpp",
"wm/windowbutton.cpp",
"wm/window.cpp",
"wm/windowlabel.cpp",
"wm/windowroundbutton.cpp",
"wm/windowpicturebox.cpp",
"wm/windowlistbox.cpp",
"wm/windowtabpanel.cpp",
"wm/windowcheckbox.cpp",
"wm/windowmainbutton.cpp",
"wm/wm.cpp",
"wm/windowscrollpanel.cpp",
"wm/windowprogressbar.cpp",
"world.cpp",

			);

$fp = fopen("Makefile","w");
fputs($fp,
"#!make
LIBS = -lGL -lz -lSDL -lGLU -lgd

%.o: %.cpp
	@echo -e \"    \033[1mCC\\033[1m\\t\\033[22;34m$<\\033[39m\"
	@$(CC) $(CFLAGS) -D__USESDL__ -c -o $@ $<


../browedit:  ");

for($i = 0; $i < count($files); $i++)
	fputs($fp, substr($files[$i],0,strrpos($files[$i],".")) . ".o ");
fputs($fp,"

	@echo -e \"    \\033[1mLD\\033[1m\\t\\033[22;35m$@\\033[39m\"
	@$(CC) $(LDFLAGS) -o $@  ");
	
for($i = 0; $i < count($files); $i++)
	fputs($fp, substr($files[$i],0,strrpos($files[$i],".")) . ".o ");
fputs($fp, "\$(LIBS)\n");
for($i = 0; $i < count($files); $i++)
{
	echo substr($files[$i],0,strrpos($files[$i],".")) . "\n";
	fputs($fp,substr($files[$i],0,strrpos($files[$i],".")).".o:");
	$filesdone = array();
	parsefile($files[$i]);
	for($ii = 0; $ii < count($filesdone); $ii++)
		fputs($fp, " " . $filesdone[$ii]);
	fputs($fp,"\n");
	
}
fputs($fp,"


clean:
	rm -f *.o
");
fclose($fp);
chdir("..");


function parsefile($filename, $includedir = "")
{
	global $filesdone;
	if (in_array($includedir . $filename, $filesdone))
		return;
	else
		$filesdone[] = $includedir . $filename;
	$dir = getcwd();
	while(stristr($filename, "/"))
	{
		chdir(substr($filename, 0, strpos($filename,"/"))) or die("Couldn't chmod to " . substr($filename, 0, strpos($filename,"/")) . " from " . getcwd() . "|" . $filename . "|");
		$includedir .= substr($filename, 0, strpos($filename,"/")+1);
		$filename = substr($filename,strpos($filename,"/")+1);
	}
	if (is_file($filename))
	{
		$f = file($filename);
		for($i = 0; $i < count($f); $i++)
		{
			$l = trim($f[$i]);
			if (substr($l, 0, 10) == "#include \"")
			{
				$include = substr($l, 10);
				$include = substr($include, 0, -1);
				parsefile($include, $includedir);
			}
		}
	}
	else
	{
		echo "Could not open " . $filename . " in directory " . getcwd() . "\n";
	}
	chdir($dir);
}


?>